---

---

# 斐波拉契哈希算法

斐波拉契数列相信都比较熟悉，就是一组整数序列，起始的两个数为0和1，从第三个数开始，每个数都是前两个数的和。具体定义如下：

![](https://raw.githubusercontent.com/binarycoder777/personal-pic/main/pic/20240621134626.png)


斐波那契哈希（Fibonacci Hashing）则是一种基于斐波那契数列的散列算法，用于将输入的整数映射到一个特定范围内的输出值。其核心思想是利用黄金分割比来减少散列冲突。


## 斐波那契哈希的原理

斐波那契哈希的基本思想是使用黄金分割比（Phi = 1.6180339887...）的倒数作为乘数，通过乘法和位移操作来计算散列值。黄金分割比的倒数接近 0.6180339887...用来生成一个伪随机分布的哈希值。

**公式**

![](https://raw.githubusercontent.com/binarycoder777/personal-pic/main/pic/20240621134846.png)


**应用场景**

- 哈希表：斐波那契哈希可以用来减少哈希冲突，从而提高哈希表的性能。（在java中，threadlocal内部的map就是采用斐波那契哈希算法解决哈希冲突的）
- 负载均衡：可以用来在分布式系统中平衡负载，确保请求均匀分布在不同服务器上。
- 缓存机制：用于分布缓存，保证数据均匀分布，减少缓存冲突，提高缓存命中率。
- 图像处理：斐波那契哈希可以用于生成伪随机数，用于图像处理中的抖动算法。

**优点**

- 减少冲突：斐波那契哈希利用黄金分割比的特性，生成的哈希值更加均匀，减少了冲突。
- 高效计算：使用乘法和位移操作，计算效率较高，适合高性能场景。

**注意事项**

- 精度问题：由于浮点数精度限制，需要使用适当的近似值来计算黄金分割比。
- 适用范围：适用于需要高效且均匀分布的哈希算法的场景，不适用于所有情况，需要根据具体应用场景选择合适的哈希算法。

## 使用斐波拉契哈希算法进行抽奖

以前大三在网易实习的时候，开发过这样一个关于抽奖的小功能，主要用于公司内部举办活动使用。其中便使用到了斐波拉契哈希算法作为抽奖的算法，主要是根据举办方提供的奖品（每个奖品都有一个唯一标识）数量，对每个奖品的唯一标识使用斐波拉契哈希算法生成一个随机下标，存入足够大的一个数组（该数组需要足够大，近可能避免奖品下标的冲突）。当抽奖时，根据生成的随机数，去匹配数组下标，如果对应下标存得有奖品，则为中奖，反正则未中奖，这个过程涉及到的抽奖并发等问题先不过多讨论，单从抽奖流程和斐波拉契哈希算法来讲，这个步骤如下图所示：

![](https://raw.githubusercontent.com/binarycoder777/personal-pic/main/pic/20240621140643.png)

上述过程实际上就是一个随机数匹配的问题，我们将实际的抽奖场景，类比到了HashMap来进行处理。同理类似的场景还有使用斐波拉契哈希算法来进行随机歌曲播放。

## 使用斐波拉契哈希算法进行歌曲随机播放

该场景来源于看到的一篇[博客](https://pncnmnp.github.io/blogs/fibonacci-hashing.html)，乍一看，你可能会想，“在播放列表中随机播放歌曲有多难？我们不能随机播放它们吗？”。该作者最开始便采用了
[Fisher–Yates 洗牌](https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle)算法来进行实现，但在实际用户使用的过程中反馈，不希望同一位歌手在短时间内播放两三次【即如果您刚刚听过某位歌手的一首歌，这并不意味着下一首歌很可能是另一位歌手的歌曲，而且顺序完全随机】。为此，为了满足用户的需求，开发人员从[Martin Fiedler](https://keyj.emphy.de/balanced-shuffle/)的一篇博客中汲取灵感，改进了该算法.

Fiedler 算法分为两部分： 合并算法和填充算法。首先，要随机播放的歌曲根据其艺术家进行分类,然后，填充算法旨在将虚拟曲目均匀分布在较短的类别中，以匹配最长类别的长度。此步骤之后是合并算法，该算法将来自不同类别的曲目组合在一起，以列方式形成单个播放列表。虽然这种方法可以非常有效地分发歌曲，但正如 Spotify 所提到的，它在某些情况下很复杂，而且速度可能很慢，特别是由于大量的随机化操作。

Spotify 建议从现有的抖动算法（如 Floyd–Steinberg 抖动）中汲取灵感，尽可能均匀地分布每位艺术家。而这便引出了斐波拉契哈希算法，前面我们了解到斐波拉契哈希算法的核心之一在于黄金分割率,黄金分割率的一个有趣的特性是， 每个后续的哈希值都会根据黄金分割率划分它所属的区间！因此，可以对上述算法进行如下改进：

![](https://raw.githubusercontent.com/binarycoder777/personal-pic/main/pic/20240621142743.png)


## 小结

斐波那契哈希算法通过使用黄金比例因子来生成均匀分布的哈希值，在哈希表设计、数据分布和图形处理等多个领域具有广泛应用。其简单高效的特点使其成为解决哈希冲突和实现负载均衡的有效工具。，除了上述讲到的抽奖和歌曲播放外，其余的一些需要随机种子的场景也可以参考改算法。但最后我想写的是：很多时候生活和数学是不分开的，但很多时候自己又容易陷入盲区，特别是在快知识的时代，很容易缺少独立思考，希望再阅读汲取他人知识的时候，能够举一反三，多些自己的思考